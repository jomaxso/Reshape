name: Prerelease on Main

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    prerelease:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get Version Info
              id: version
              run: |
                  # Read version from eng/Versions.props
                  MAJOR=$(grep -oP '<MajorVersion>\K[^<]+' eng/Versions.props)
                  MINOR=$(grep -oP '<MinorVersion>\K[^<]+' eng/Versions.props)
                  PATCH=$(grep -oP '<PatchVersion>\K[^<]+' eng/Versions.props)
                  BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"

                  SHORT_SHA=$(git rev-parse --short HEAD)
                  BUILD_NUMBER=$(git rev-list --count HEAD)
                  TIMESTAMP=$(date -u +%Y%m%d.%H%M%S)
                  PRERELEASE_VERSION="${BASE_VERSION}-preview.${BUILD_NUMBER}"
                  TAG_NAME="v${PRERELEASE_VERSION}"

                  echo "prerelease_version=${PRERELEASE_VERSION}" >> $GITHUB_OUTPUT
                  echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
                  echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
                  echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
                  echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

            - name: Delete existing prerelease tag if exists
              continue-on-error: true
              run: |
                  TAG_NAME="${{ steps.version.outputs.tag_name }}"
                  # Delete the tag if it exists (shouldn't happen with unique build numbers, but just in case)
                  git push origin :refs/tags/${TAG_NAME} || true
                  gh release delete ${TAG_NAME} --yes || true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Prerelease Tag
              run: |
                  TAG_NAME="${{ steps.version.outputs.tag_name }}"

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "${TAG_NAME}" -m "Prerelease ${{ steps.version.outputs.prerelease_version }}"
                  git push origin "${TAG_NAME}"

                  echo "Created tag: ${TAG_NAME}"
                  echo "The build-and-release workflow will be triggered to build and upload binaries."

            - name: Summary
              run: |
                  echo "## ðŸš§ Prerelease Tag Created" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Tag:** ${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${{ steps.version.outputs.prerelease_version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ steps.version.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The **build-and-release** workflow will automatically:" >> $GITHUB_STEP_SUMMARY
                  echo "1. Build binaries for Windows, Linux, and macOS" >> $GITHUB_STEP_SUMMARY
                  echo "2. Create the GitHub release with assets" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”— [View Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
