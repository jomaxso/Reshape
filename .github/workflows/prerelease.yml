name: Prerelease on Main

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    prerelease:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get Version Info
              id: version
              run: |
                  # Read version from eng/Versions.props
                  MAJOR=$(grep -oP '<MajorVersion>\K[^<]+' eng/Versions.props)
                  MINOR=$(grep -oP '<MinorVersion>\K[^<]+' eng/Versions.props)
                  PATCH=$(grep -oP '<PatchVersion>\K[^<]+' eng/Versions.props)
                  BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"

                  SHORT_SHA=$(git rev-parse --short HEAD)
                  BUILD_NUMBER=$(git rev-list --count HEAD)
                  TIMESTAMP=$(date -u +%Y%m%d.%H%M%S)
                  PRERELEASE_VERSION="${BASE_VERSION}-preview.${BUILD_NUMBER}"

                  echo "prerelease_version=${PRERELEASE_VERSION}" >> $GITHUB_OUTPUT
                  echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
                  echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
                  echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

            - name: Delete existing prerelease
              continue-on-error: true
              run: |
                  git push origin :refs/tags/prerelease || true
                  gh release delete prerelease --yes || true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Prerelease Tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -f prerelease -m "Prerelease ${{ steps.version.outputs.prerelease_version }}"
                  git push -f origin prerelease

            - name: Create Prerelease
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: prerelease
                  name: "üöß Prerelease ${{ steps.version.outputs.prerelease_version }}"
                  body: |
                      # üöß Automated Prerelease Build

                      **Version:** `${{ steps.version.outputs.prerelease_version }}`  
                      **Commit:** ${{ steps.version.outputs.short_sha }}  
                      **Build:** #${{ steps.version.outputs.build_number }}

                      ---

                      **‚ö†Ô∏è This is a prerelease build from the main branch. Not recommended for production use.**

                      ```bash
                      curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash -s -- --prerelease
                      ```
                      Or

                      Run remotely in PowerShell:
                      ```powershell
                      iex "& { $(irm https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.ps1) } -Prerelease"
                      ```

                      ---

                      *This prerelease is automatically created on every push to main.*
                  draft: false
                  prerelease: true
                  generate_release_notes: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
