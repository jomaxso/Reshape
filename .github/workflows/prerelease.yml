name: Prerelease on Main

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    prerelease:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '10.0.x'

            - name: Install Nerdbank.GitVersioning
              run: dotnet tool install -g nbgv

            - name: Get Version Info
              id: version
              run: |
                  VERSION=$(nbgv get-version -v Version)
                  ASSEMBLY_VERSION=$(nbgv get-version -v AssemblyVersion)
                  NUGET_VERSION=$(nbgv get-version -v NuGetPackageVersion)
                  GIT_COMMIT=$(nbgv get-version -v GitCommitIdShort)
                  BUILD_NUMBER=$(nbgv get-version -v BuildNumber)

                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "assembly_version=${ASSEMBLY_VERSION}" >> $GITHUB_OUTPUT
                  echo "nuget_version=${NUGET_VERSION}" >> $GITHUB_OUTPUT
                  echo "git_commit=${GIT_COMMIT}" >> $GITHUB_OUTPUT
                  echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

            - name: Delete existing prerelease
              continue-on-error: true
              run: |
                  git push origin :refs/tags/prerelease || true
                  gh release delete prerelease --yes || true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Prerelease Tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -f prerelease -m "Prerelease ${{ steps.version.outputs.version }}"
                  git push -f origin prerelease

            - name: Create Prerelease
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: prerelease
                  name: "üöß Prerelease ${{ steps.version.outputs.version }}"
                  body: |
                      # üöß Automated Prerelease Build

                      **Version:** `${{ steps.version.outputs.version }}`  
                      **NuGet Version:** `${{ steps.version.outputs.nuget_version }}`  
                      **Commit:** ${{ steps.version.outputs.git_commit }}  
                      **Build:** #${{ steps.version.outputs.build_number }}

                      ---

                      **‚ö†Ô∏è This is a prerelease build from the main branch. Not recommended for production use.**

                      ```bash
                      curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash -s -- --prerelease
                      ```
                      Or

                      Run remotely in PowerShell:
                      ```powershell
                      iex "& { $(irm https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.ps1) } -Prerelease"
                      ```

                      ---

                      *This prerelease is automatically created on every push to main.*
                  draft: false
                  prerelease: true
                  generate_release_notes: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
