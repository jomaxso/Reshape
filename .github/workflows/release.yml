name: Create Stable Release

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Release version (leave empty to use version from .csproj)"
                required: false
                type: string
            prerelease:
                description: "Mark as prerelease"
                required: false
                type: boolean
                default: false

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Get Version
              id: version
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                    echo "Using manual version: ${VERSION}"
                  else
                    VERSION=$(grep -oP '<Version>\K[^<]+' reshape-cli/Reshape.Cli.csproj)
                    echo "Using version from .csproj: ${VERSION}"
                  fi
                  
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  
                  # Check if tag already exists
                  if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
                    echo "::error::Tag v${VERSION} already exists!"
                    exit 1
                  fi

            - name: Create Release Tag
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  
                  # Create and push tag
                  git tag -a "v${VERSION}" -m "Release v${VERSION}"
                  git push origin "v${VERSION}"
                  
                  echo "Created and pushed tag v${VERSION}"

            - name: Wait for Tag Push
              run: sleep 5

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: v${{ steps.version.outputs.version }}
                  body: |
                      # Release v${{ steps.version.outputs.version }}
                      
                      ```bash
                      curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash
                      ```
                      Or
                      
                      Run remotely in PowerShell:
                      ```powershell
                      iex "& { $(irm https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.ps1) }"
                      ```
                      
                      Or download the binaries manually below.
                      
                      ## What's Changed
                      
                      _Release notes will be generated automatically._
                      
                      ---
                      
                      **Full Changelog**: https://github.com/${{ github.repository }}/commits/v${{ steps.version.outputs.version }}
                  draft: false
                  prerelease: ${{ github.event.inputs.prerelease == 'true' }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Summary
              run: |
                  echo "## âœ… Release Created" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Prerelease:** ${{ github.event.inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "The build-and-release workflow will automatically build and upload binaries." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
